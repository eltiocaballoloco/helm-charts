name: Release Helm Charts

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Install Helm
        run: |
          curl -fsSL https://get.helm.sh/helm-v3.17.3-linux-amd64.tar.gz | tar -xz
          sudo mv linux-amd64/helm /usr/local/bin/helm

      - name: Prepare chart directory
        run: |
          mkdir -p charts/tmp-chart
          cp -r main-charts/* charts/tmp-chart/

      - name: Lint chart
        run: helm lint charts/tmp-chart

      - name: Extract chart version
        id: chart_version
        run: |
          VERSION=$(grep '^version:' main-charts/Chart.yaml | awk '{print $2}')
          echo "chart_version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Git tag
        id: create_tag
        run: |
          TAG="v${{ steps.chart_version.outputs.chart_version }}"
          git config user.name "eltiocaballoloco-bot"
          git config user.email "eltio@noreply.github.com"
          git tag "$TAG"
          git push origin "$TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Wait for tag propagation
        run: sleep 10

      - name: Run chart-releaser-action
        uses: helm/chart-releaser-action@v1.5.0
        with:
          charts_dir: charts
        env:
          CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Helm chart to GitHub Releases
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.create_tag.outputs.tag }}
          files: cr-release/*.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push Helm charts and index.yaml to gs-pages
        run: |
          git config user.name "eltiocaballoloco-bot"
          git config user.email "eltio@noreply.github.com"
          git fetch origin gs-pages || git checkout --orphan gs-pages
          git checkout gs-pages
          mkdir -p .
          cp -r cr-release/* .
          git add .
          git commit -m "Update Helm charts and index.yaml for version ${{ steps.chart_version.outputs.chart_version }}" || echo "No changes to commit"
          git push origin gs-pages
