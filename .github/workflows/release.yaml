name: Release Helm Charts
on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install Helm 3.17.3
        run: |
          curl -fsSL https://get.helm.sh/helm-v3.17.3-linux-amd64.tar.gz | tar -xz
          sudo mv linux-amd64/helm /usr/local/bin/helm

      - name: Check Helm version
        run: helm version

      - name: Lint Helm charts
        run: helm lint ./main-charts

      - name: Package Helm charts
        run: helm package ./main-charts

      - name: Extract Chart version
        id: chart_version
        run: |
          VERSION=$(grep '^version:' main-charts/Chart.yaml | awk '{print $2}')
          echo "chart_version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Git Tag from Chart.yaml
        id: create_tag
        run: |
          TAG="v${{ steps.chart_version.outputs.chart_version }}"
          git config user.name "eltiocaballoloco-bot"
          git config user.email "eltio@noreply.github.com"
          git tag "$TAG"
          git push origin "$TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Upload Helm chart to GitHub Releases
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.create_tag.outputs.tag }}
          files: '*.tgz'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install chart-releaser
        uses: helm/chart-releaser-action@v1.5.0
        with:
          charts_dir: main-charts
        env:
          CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push Helm charts and index.yaml to gs-pages branch
        run: |
          git config user.name "eltiocaballoloco-bot"
          git config user.email "eltio@noreply.github.com"
          git fetch origin gs-pages
          git checkout gs-pages
          cp -r cr-release/* .
          git add .
          git commit -m "Update Helm charts and index.yaml for version ${{ steps.chart_version.outputs.chart_version }}" || echo "No changes to commit"
          git push origin gs-pages
